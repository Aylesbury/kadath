syntax = "proto3";

package sql.v1;

option go_package = "./sql_runner";

service SqlRunner {
  // Agent requests a job to process
  rpc GetJob (GetJobRequest) returns (GetJobResponse);

  // Agent reports result
  rpc UpdateJob (UpdateJobRequest) returns (UpdateJobResponse);

  // Agent sends heartbeat
  rpc Heartbeat (HeartbeatRequest) returns (HeartbeatResponse);
}

enum JobKind {
  JOB_KIND_UNSPECIFIED = 0;
  JOB_KIND_PING = 1;
  JOB_KIND_QUERY = 2;
  JOB_KIND_DSL_QUERY = 3;
  JOB_KIND_SCHEMA_REFRESH = 4;
  JOB_KIND_FETCH_COLUMNS = 5;
}

message HeartbeatRequest {
  string agent_id = 1;
}

message HeartbeatResponse {
  bool success = 1;
}

message GetJobRequest {
  repeated JobKind supported_kinds = 1;
  string agent_id = 2;
}

message GetJobResponse {
  bool has_job = 1;
  Job job = 2;
}

message Job {
  string id = 1;
  JobKind kind = 2;
  string payload_json = 3;
}

message UpdateJobRequest {
  string job_id = 1;
  string agent_id = 2;
  bool success = 3;
  string result_json = 4;
  string error_message = 5;
}

message UpdateJobResponse {
  bool success = 1;
}
